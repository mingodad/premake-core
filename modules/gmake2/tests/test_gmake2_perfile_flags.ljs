//
// gmake2_perfile_flags.ljs
// Tests compiler and linker flags for Makefiles.
// (c) 2016-2017 Jason Perkins, Blizzard Entertainment and the Premake project
//

	var suite = test.declare("gmake2_perfile_flags");

	var p = premake;
	var gmake2 = p.modules.gmake2;

	var project = p.project;


//
// Setup
//
	var wks;

	function suite.setup() {
		wks = test.createWorkspace();
	}

	var function prepare() {
		var prj = p.workspace.getproject(wks, 1);
		gmake2.cpp.outputPerFileConfigurationSection(prj);
	}


//
// Test per file settings.
//

	function suite.perfile_buildOptions() {
		files ({ 'a.cpp', 'b.cpp', 'c.cpp' });

		filter ({ 'files:a.cpp' });
			buildoptions ({ '-msse', '-msse2', '-mfpmath=sse,387', '-msse3', '-mssse3', '-msse4.1', '-mpclmul' });
		filter ({ 'files:b.cpp' });
			buildoptions ({ '-msse', '-msse2', '-mfpmath=sse,387' });
		filter ({ 'files:c.cpp' });
			buildoptions ({ '-msse', '-msse2', '-mfpmath=sse,387', '-msse3', '-mssse3', '-msse4.1', '-maes' });

		prepare();
		test.capture ([=[
# Per File Configurations
# #############################################

PERFILE_FLAGS_0 = $(ALL_CXXFLAGS) -msse -msse2 -mfpmath=sse,387 -msse3 -mssse3 -msse4.1 -mpclmul
PERFILE_FLAGS_1 = $(ALL_CXXFLAGS) -msse -msse2 -mfpmath=sse,387
PERFILE_FLAGS_2 = $(ALL_CXXFLAGS) -msse -msse2 -mfpmath=sse,387 -msse3 -mssse3 -msse4.1 -maes
		]=]);
	}


	function suite.perfile_mixedbuildOptions() {
		files ({ 'a.c', 'b.cpp', 'c.c' });

		filter ({ 'files:a.c' });
			buildoptions ({ '-msse', '-msse2', '-mfpmath=sse,387', '-msse3', '-mssse3', '-msse4.1', '-mpclmul' });
		filter ({ 'files:b.cpp' });
			buildoptions ({ '-msse', '-msse2', '-mfpmath=sse,387' });
		filter ({ 'files:c.c' });
			buildoptions ({ '-msse', '-msse2', '-mfpmath=sse,387', '-msse3', '-mssse3', '-msse4.1', '-maes' });

		prepare();
		test.capture ([=[
# Per File Configurations
# #############################################

PERFILE_FLAGS_0 = $(ALL_CFLAGS) -msse -msse2 -mfpmath=sse,387 -msse3 -mssse3 -msse4.1 -mpclmul
PERFILE_FLAGS_1 = $(ALL_CXXFLAGS) -msse -msse2 -mfpmath=sse,387
PERFILE_FLAGS_2 = $(ALL_CFLAGS) -msse -msse2 -mfpmath=sse,387 -msse3 -mssse3 -msse4.1 -maes
		]=]);
	}

	function suite.perfile_cxxApi() {
		files ({ 'a.cpp', 'b.cpp', 'c.cpp' });

		visibility ("Hidden");

		filter ({ 'files:b.cpp' });
			visibility ("Protected");

		prepare();
		test.capture ([=[
# Per File Configurations
# #############################################

PERFILE_FLAGS_0 = $(ALL_CXXFLAGS) -fvisibility=protected
		]=]);
	}
