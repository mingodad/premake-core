//
// tests/actions/make/cpp/test_make_pch.ljs
// Validate the setup for precompiled headers in makefiles.
// Copyright (c) 2010-2013 Jason Perkins and the Premake project
//

	var p = premake;
	var suite = test.declare("make_pch");
	var make = p.make;
	var project = p.project;



//
// Setup and teardown
//

	var wks, prj;
	function suite.setup() {
		os.chdir(_TESTS_DIR);
		wks, prj = test.createWorkspace();
	}

	var function prepareVars() {
		var cfg = test.getconfig(prj, "Debug");
		make.pch(cfg);
	}

	var function prepareRules() {
		var cfg = test.getconfig(prj, "Debug");
		make.pchRules(cfg.project);
	}


//
// If no header has been set, nothing should be output.
//

	function suite.noConfig_onNoHeaderSet() {
		prepareVars();
		test.isemptycapture();
	}


//
// If a header is set, but the NoPCH flag is also set, then
// nothing should be output.
//

	function suite.noConfig_onHeaderAndNoPCHFlag() {
		pchheader ("include/myproject.h");
		flags ("NoPCH");
		prepareVars();
		test.isemptycapture();
	}


//
// If a header is specified and the NoPCH flag is not set, then
// the header can be used.
//

	function suite.config_onPchEnabled() {
		pchheader ("include/myproject.h");
		prepareVars();
		test.capture ([=[
  PCH = include/myproject.h
  GCH = $(OBJDIR)/$(notdir $(PCH)).gch
		]=]);
	}


//
// The PCH can be specified relative the an includes search path.
//

	function suite.pch_searchesIncludeDirs() {
		pchheader ("premake.h");
		includedirs ({ "../../../src/host" });
		prepareVars();
		test.capture ([=[
  PCH = ../../../src/host/premake.h
		]=]);
	}


//
// Verify the format of the PCH rules block for a C++ file.
//

	function suite.buildRules_onCpp() {
		pchheader ("include/myproject.h");
		prepareRules();
		test.capture ([=[
ifneq (,$(PCH))
$(OBJECTS): $(GCH) $(PCH) | $(OBJDIR)
$(GCH): $(PCH) | $(OBJDIR)
	@echo $(notdir $<)
	$(SILENT) $(CXX) -x c++-header $(ALL_CXXFLAGS) -o "$@" -MF "$(@:%.gch=%.d)" -c "$<"
else
$(OBJECTS): | $(OBJDIR)
endif
		]=]);
	}


//
// Verify the format of the PCH rules block for a C file.
//

	function suite.buildRules_onC() {
		language ("C");
		pchheader ("include/myproject.h");
		prepareRules();
		test.capture ([=[
ifneq (,$(PCH))
$(OBJECTS): $(GCH) $(PCH) | $(OBJDIR)
$(GCH): $(PCH) | $(OBJDIR)
	@echo $(notdir $<)
	$(SILENT) $(CC) -x c-header $(ALL_CFLAGS) -o "$@" -MF "$(@:%.gch=%.d)" -c "$<"
else
$(OBJECTS): | $(OBJDIR)
endif
		]=]);
	}



	//
	// If the header is located on one of the include file
	// search directories, it should get found automatically.
	//

		function suite.findsPCH_onIncludeDirs() {
			location ("MyProject");
			pchheader ("premake.h");
			includedirs ({ "../../../src/host" });
			prepareVars();
			test.capture ([=[
  PCH = ../../../../src/host/premake.h
			]=]);
		}
